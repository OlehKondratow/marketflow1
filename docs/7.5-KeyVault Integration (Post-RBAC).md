
### **5.4. Key Vault Integration with AKS (Post-RBAC)**

> üîí This step must be executed **after AKS creation** and **after assigning RBAC roles** to its Managed Identity.

#### 1Ô∏è‚É£ Assign AKS Managed Identity Access to the Vault

```bash
# Get AKS managed identity (SystemAssigned) principal ID
az aks show -n marketflow-aks -g marketflow-rg --query identity.principalId -o tsv
55b5f02b-f51e-4d8d-930a-25f6a02d7033
```

Assign required roles:

```bash
# Allow cluster to manage network and access secrets
az role assignment create \
  --assignee 55b5f02b-f51e-4d8d-930a-25f6a02d7033 \
  --role "Network Contributor" \
  --scope /subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourceGroups/marketflow-rg
```
```json
{
  "condition": null,
  "conditionVersion": null,
  "createdBy": null,
  "createdOn": "2025-10-27T12:42:48.153780+00:00",
  "delegatedManagedIdentityResourceId": null,
  "description": null,
  "id": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourceGroups/marketflow-rg/providers/Microsoft.Authorization/roleAssignments/4930a2b4-887c-48ce-b83a-95c716772d51",
  "name": "4930a2b4-887c-48ce-b83a-95c716772d51",
  "principalId": "55b5f02b-f51e-4d8d-930a-25f6a02d7033",
  "principalType": "ServicePrincipal",
  "resourceGroup": "marketflow-rg",
  "roleDefinitionId": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/providers/Microsoft.Authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7",
  "scope": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourceGroups/marketflow-rg",
  "type": "Microsoft.Authorization/roleAssignments",
  "updatedBy": "9ef05d8f-5e3a-46a7-b56f-b494d734fee6",
  "updatedOn": "2025-10-27T12:42:48.654781+00:00"
}
```

```
az role assignment create \
  --assignee 55b5f02b-f51e-4d8d-930a-25f6a02d7033 \
  --role "Key Vault Secrets Officer" \
  --scope $(az keyvault show --name marketflow-vault --query id -o tsv)

```
```json
{
  "condition": null,
  "conditionVersion": null,
  "createdBy": null,
  "createdOn": "2025-10-27T12:44:26.734282+00:00",
  "delegatedManagedIdentityResourceId": null,
  "description": null,
  "id": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourceGroups/marketflow-rg/providers/Microsoft.KeyVault/vaults/marketflow-vault/providers/Microsoft.Authorization/roleAssignments/21b17e3d-6185-423e-9d54-248fb9136ba1",
  "name": "21b17e3d-6185-423e-9d54-248fb9136ba1",
  "principalId": "55b5f02b-f51e-4d8d-930a-25f6a02d7033",
  "principalType": "ServicePrincipal",
  "resourceGroup": "marketflow-rg",
  "roleDefinitionId": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/providers/Microsoft.Authorization/roleDefinitions/b86a8fe4-44ce-4948-aee5-eccb2c155cd7",
  "scope": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourceGroups/marketflow-rg/providers/Microsoft.KeyVault/vaults/marketflow-vault",
  "type": "Microsoft.Authorization/roleAssignments",
  "updatedBy": "9ef05d8f-5e3a-46a7-b56f-b494d734fee6",
  "updatedOn": "2025-10-27T12:44:27.249286+00:00"
}
```
Verify the role assignments:

```bash
az role assignment list \
  --assignee 55b5f02b-f51e-4d8d-930a-25f6a02d7033 \
  --scope $(az keyvault show --name marketflow-vault --query id -o tsv) \
  --output table
```

---

#### 2Ô∏è‚É£ Enable the Key Vault CSI Secrets Provider in AKS

```bash
az aks enable-addons \
  --addons azure-keyvault-secrets-provider \
  --name marketflow-aks \
  --resource-group marketflow-rg
```
```json
{
  "aadProfile": null,
  "addonProfiles": {
    "azureKeyvaultSecretsProvider": {
      "config": {
        "enableSecretRotation": "false",
        "rotationPollInterval": "2m"
      },
      "enabled": true,
      "identity": {
        "clientId": "b2bb72ab-f6ce-445d-b19d-b4feda58af96",
        "objectId": "5e8c8dfc-cad4-4e56-84b9-ce56c26dc5f1",
        "resourceId": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourcegroups/MC_marketflow-rg_marketflow-aks_westeurope/providers/Microsoft.ManagedIdentity/userAssignedIdentities/azurekeyvaultsecretsprovider-marketflow-aks"
      }
    },
    "omsagent": {
      "config": {
        "logAnalyticsWorkspaceResourceID": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourceGroups/DefaultResourceGroup-WEU/providers/Microsoft.OperationalInsights/workspaces/DefaultWorkspace-65fe7e97-9f6f-4f82-b940-4f374ca027cb-WEU",
        "useAADAuth": "true"
      },
      "enabled": true,
      "identity": null
    }
  },
  "agentPoolProfiles": [
    {
      "availabilityZones": null,
      "capacityReservationGroupId": null,
      "count": 2,
      "creationData": null,
      "currentOrchestratorVersion": "1.32.7",
      "eTag": null,
      "enableAutoScaling": false,
      "enableEncryptionAtHost": false,
      "enableFips": false,
      "enableNodePublicIp": false,
      "enableUltraSsd": false,
      "gatewayProfile": null,
      "gpuInstanceProfile": null,
      "gpuProfile": null,
      "hostGroupId": null,
      "kubeletConfig": null,
      "kubeletDiskType": "OS",
      "linuxOsConfig": null,
      "maxCount": null,
      "maxPods": 250,
      "messageOfTheDay": null,
      "minCount": null,
      "mode": "System",
      "name": "nodepool1",
      "networkProfile": null,
      "nodeImageVersion": "AKSUbuntu-2204gen2containerd-202510.03.0",
      "nodeLabels": null,
      "nodePublicIpPrefixId": null,
      "nodeTaints": null,
      "orchestratorVersion": "1.32",
      "osDiskSizeGb": 128,
      "osDiskType": "Managed",
      "osSku": "Ubuntu",
      "osType": "Linux",
      "podIpAllocationMode": null,
      "podSubnetId": null,
      "powerState": {
        "code": "Running"
      },
      "provisioningState": "Succeeded",
      "proximityPlacementGroupId": null,
      "scaleDownMode": "Delete",
      "scaleSetEvictionPolicy": null,
      "scaleSetPriority": null,
      "securityProfile": {
        "enableSecureBoot": false,
        "enableVtpm": false
      },
      "spotMaxPrice": null,
      "status": null,
      "tags": null,
      "type": "VirtualMachineScaleSets",
      "upgradeSettings": {
        "drainTimeoutInMinutes": null,
        "maxSurge": "10%",
        "maxUnavailable": "0",
        "nodeSoakDurationInMinutes": null,
        "undrainableNodeBehavior": null
      },
      "virtualMachineNodesStatus": null,
      "virtualMachinesProfile": null,
      "vmSize": "Standard_B2s",
      "vnetSubnetId": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourceGroups/marketflow-rg/providers/Microsoft.Network/virtualNetworks/marketflow-vnet/subnets/aks-subnet",
      "windowsProfile": null,
      "workloadRuntime": null
    }
  ],
  "aiToolchainOperatorProfile": null,
  "apiServerAccessProfile": null,
  "autoScalerProfile": null,
  "autoUpgradeProfile": {
    "nodeOsUpgradeChannel": "NodeImage",
    "upgradeChannel": null
  },
  "azureMonitorProfile": {
    "metrics": null
  },
  "azurePortalFqdn": "marketflow-marketflow-rg-65fe7e-kh98rsoj.portal.hcp.westeurope.azmk8s.io",
  "bootstrapProfile": {
    "artifactSource": "Direct",
    "containerRegistryId": null
  },
  "currentKubernetesVersion": "1.32.7",
  "disableLocalAccounts": false,
  "diskEncryptionSetId": null,
  "dnsPrefix": "marketflow-marketflow-rg-65fe7e",
  "eTag": null,
  "enableRbac": true,
  "extendedLocation": null,
  "fqdn": "marketflow-marketflow-rg-65fe7e-kh98rsoj.hcp.westeurope.azmk8s.io",
  "fqdnSubdomain": null,
  "httpProxyConfig": null,
  "id": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourcegroups/marketflow-rg/providers/Microsoft.ContainerService/managedClusters/marketflow-aks",
  "identity": {
    "delegatedResources": null,
    "principalId": "55b5f02b-f51e-4d8d-930a-25f6a02d7033",
    "tenantId": "7f776ea7-75ee-492e-83f3-40a9552b9320",
    "type": "SystemAssigned",
    "userAssignedIdentities": null
  },
  "identityProfile": {
    "kubeletidentity": {
      "clientId": "0280abe8-9ccd-435b-ad84-6a46a8f7fbb9",
      "objectId": "64515080-80e9-45e8-9ecf-a9a11fe04c91",
      "resourceId": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourcegroups/MC_marketflow-rg_marketflow-aks_westeurope/providers/Microsoft.ManagedIdentity/userAssignedIdentities/marketflow-aks-agentpool"
    }
  },
  "ingressProfile": null,
  "kind": "Base",
  "kubernetesVersion": "1.32",
  "linuxProfile": {
    "adminUsername": "azureuser",
    "ssh": {
      "publicKeys": [
        {
          "keyData": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC8CfNHvXqA6GYMPwxSo43WOXpkCotxxn99tUHImfzv6TiM5ey/PtpMjnMaXSPJ0sCMafNSq+TZXoGRHLyRYa5y/ulFdFfjlLCSS2JmS0FX63Z2+0BQPcKxFTrmamUVXYNKjeScT0nGDg1OCLdyi/AG4wqXWvOoE71FzDWW5B69kcUyqW8h9NLU79sU/oveI/RZGXdpwT7vDlLTPmDECp4hnIbP/KSt+zKyMraPLeVMBPY4Wfcmm34ckf3xhfmVCi2U3/TNEL1IfOyuAkag3DKtV0MRgy1WVLGpxXxPNVDsHGedgbnbfXvVcDZ8Q6IZZN+uiz1iBqQyc7knYxbr5uOmBZT0hg94isNpIghlLYXiP2p5KJYGyijrpWH3APIISoKbLm2uE9a8p2HgZ9uIX1OHR6lPSvOM8hHks1jk8itpv4K1ISo+Mo1+Vq1UNMZV40MDlpvDgqmDXlSZdjySAPU4ujjtId3kOm9sR+87TM3hInZ/pceFzuyxhAt35wOMffs= pilgrim@ws5\n"
        }
      ]
    }
  },
  "location": "westeurope",
  "maxAgentPools": 100,
  "metricsProfile": {
    "costAnalysis": {
      "enabled": false
    }
  },
  "name": "marketflow-aks",
  "networkProfile": {
    "advancedNetworking": null,
    "dnsServiceIp": "10.0.0.10",
    "ipFamilies": [
      "IPv4"
    ],
    "loadBalancerProfile": {
      "allocatedOutboundPorts": null,
      "backendPoolType": "nodeIPConfiguration",
      "effectiveOutboundIPs": [
        {
          "id": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourceGroups/MC_marketflow-rg_marketflow-aks_westeurope/providers/Microsoft.Network/publicIPAddresses/ca46de0d-3ebf-40d2-b5d0-1b4c5d66f1bf",
          "resourceGroup": "MC_marketflow-rg_marketflow-aks_westeurope"
        }
      ],
      "enableMultipleStandardLoadBalancers": null,
      "idleTimeoutInMinutes": null,
      "managedOutboundIPs": {
        "count": 1,
        "countIpv6": null
      },
      "outboundIPs": null,
      "outboundIpPrefixes": null
    },
    "loadBalancerSku": "standard",
    "natGatewayProfile": null,
    "networkDataplane": "azure",
    "networkMode": null,
    "networkPlugin": "azure",
    "networkPluginMode": "overlay",
    "networkPolicy": "none",
    "outboundType": "loadBalancer",
    "podCidr": "10.244.0.0/16",
    "podCidrs": [
      "10.244.0.0/16"
    ],
    "serviceCidr": "10.0.0.0/16",
    "serviceCidrs": [
      "10.0.0.0/16"
    ],
    "staticEgressGatewayProfile": null
  },
  "nodeProvisioningProfile": {
    "defaultNodePools": "Auto",
    "mode": "Manual"
  },
  "nodeResourceGroup": "MC_marketflow-rg_marketflow-aks_westeurope",
  "nodeResourceGroupProfile": null,
  "oidcIssuerProfile": {
    "enabled": true,
    "issuerUrl": "https://westeurope.oic.prod-aks.azure.com/7f776ea7-75ee-492e-83f3-40a9552b9320/9f7ef169-02d3-424e-bda2-fce56a40e772/"
  },
  "podIdentityProfile": null,
  "powerState": {
    "code": "Running"
  },
  "privateFqdn": null,
  "privateLinkResources": null,
  "provisioningState": "Succeeded",
  "publicNetworkAccess": null,
  "resourceGroup": "marketflow-rg",
  "resourceUid": "68ff63cee8f4cf0001b5b4fe",
  "securityProfile": {
    "azureKeyVaultKms": null,
    "customCaTrustCertificates": null,
    "defender": null,
    "imageCleaner": null,
    "workloadIdentity": {
      "enabled": true
    }
  },
  "serviceMeshProfile": null,
  "servicePrincipalProfile": {
    "clientId": "msi",
    "secret": null
  },
  "sku": {
    "name": "Base",
    "tier": "Free"
  },
  "status": null,
  "storageProfile": {
    "blobCsiDriver": null,
    "diskCsiDriver": {
      "enabled": true
    },
    "fileCsiDriver": {
      "enabled": true
    },
    "snapshotController": {
      "enabled": true
    }
  },
  "supportPlan": "KubernetesOfficial",
  "systemData": null,
  "tags": null,
  "type": "Microsoft.ContainerService/ManagedClusters",
  "upgradeSettings": null,
  "windowsProfile": {
    "adminPassword": null,
    "adminUsername": "azureuser",
    "enableCsiProxy": true,
    "gmsaProfile": null,
    "licenseType": null
  },
  "workloadAutoScalerProfile": {
    "keda": null,
    "verticalPodAutoscaler": null
  }
}
```
---

#### 3Ô∏è‚É£ Verify CSI Driver Pods

```bash
ubectl get pods -n kube-system | grep csi
aks-secrets-store-csi-driver-2qb9g                    3/3     Running   0             3m45s
aks-secrets-store-csi-driver-7d25p                    3/3     Running   0             3m45s
csi-azuredisk-node-4r74l                              3/3     Running   0             26m
csi-azuredisk-node-qfqm9                              3/3     Running   0             26m
csi-azurefile-node-pq2pq                              3/3     Running   0             26m
csi-azurefile-node-vrq45                              3/3     Running   0             26m
```

‚úÖ Once these pods are in `Running` state, the cluster can securely mount Key Vault secrets into pods.

az role assignment create \
  --assignee-object-id 5e8c8dfc-cad4-4e56-84b9-ce56c26dc5f1 \
  --assignee-principal-type ServicePrincipal \
  --role "Key Vault Secrets User" \
  --scope $(az keyvault show --name marketflow-vault --query id -o tsv)
```json
{
  "condition": null,
  "conditionVersion": null,
  "createdBy": null,
  "createdOn": "2025-10-27T13:00:21.012388+00:00",
  "delegatedManagedIdentityResourceId": null,
  "description": null,
  "id": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourceGroups/marketflow-rg/providers/Microsoft.KeyVault/vaults/marketflow-vault/providers/Microsoft.Authorization/roleAssignments/36f7959e-152a-4a01-a9f3-1c0bee63fc1b",
  "name": "36f7959e-152a-4a01-a9f3-1c0bee63fc1b",
  "principalId": "5e8c8dfc-cad4-4e56-84b9-ce56c26dc5f1",
  "principalType": "ServicePrincipal",
  "resourceGroup": "marketflow-rg",
  "roleDefinitionId": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/providers/Microsoft.Authorization/roleDefinitions/4633458b-17de-408a-b874-0445c86b69e6",
  "scope": "/subscriptions/65fe7e97-9f6f-4f82-b940-4f374ca027cb/resourceGroups/marketflow-rg/providers/Microsoft.KeyVault/vaults/marketflow-vault",
  "type": "Microsoft.Authorization/roleAssignments",
  "updatedBy": "9ef05d8f-5e3a-46a7-b56f-b494d734fee6",
  "updatedOn": "2025-10-27T13:00:21.615475+00:00"
}
```
kubectl apply -f k8s/kv-test.yaml
pod/kv-test created
```
kubectl get pods -n default
```

```
NAME      READY   STATUS    RESTARTS   AGE
kv-test   1/1     Running   0          6s
```
```
kubectl describe pods kv-test -n default
```
```
Name:             kv-test
Namespace:        default
Priority:         0
Service Account:  default
Node:             aks-nodepool1-66138655-vmss000001/10.240.0.4
Start Time:       Mon, 27 Oct 2025 14:02:01 +0100
Labels:           <none>
Annotations:      <none>
Status:           Running
IP:               10.244.0.175
IPs:
  IP:  10.244.0.175
Containers:
  busybox:
    Container ID:  containerd://a7a56bcc094eda46932d732951664d33e97c3a9a7e0c783df007d840f64bdfc1
    Image:         busybox
    Image ID:      docker.io/library/busybox@sha256:2f590fc602ce325cbff2ccfc39499014d039546dc400ef8bbf5c6ffb860632e7
    Port:          <none>
    Host Port:     <none>
    Command:
      sleep
      3600
    State:          Running
      Started:      Mon, 27 Oct 2025 14:02:02 +0100
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /mnt/secrets-store from secrets-store-inline (ro)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-rhh6v (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True 
  Initialized                 True 
  Ready                       True 
  ContainersReady             True 
  PodScheduled                True 
Volumes:
  secrets-store-inline:
    Type:              CSI (a Container Storage Interface (CSI) volume source)
    Driver:            secrets-store.csi.k8s.io
    FSType:            
    ReadOnly:          true
    VolumeAttributes:      secretProviderClass=azure-kv-test
  kube-api-access-rhh6v:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  50s   default-scheduler  Successfully assigned default/kv-test to aks-nodepool1-66138655-vmss000001
  Normal  Pulling    49s   kubelet            Pulling image "busybox"
  Normal  Pulled     49s   kubelet            Successfully pulled image "busybox" in 705ms (705ms including waiting). Image size: 2223686 bytes.
  Normal  Created    49s   kubelet            Created container: busybox
  Normal  Started    49s   kubelet            Started container busybox
```

```
 kubectl exec -it kv-test -- ls /mnt/secrets-store
KafkaConnectionString      SnowflakeConnectionString
```
(data-lab) kinga@mworker1:14:04:18:~/works/marketflow
```
 kubectl exec -it kv-test -- cat /mnt/secrets-store/KafkaConnectionString
```

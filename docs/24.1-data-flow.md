## üß© –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è MarketFlow Microservices MVP

**1 Kafka-—à–∏–Ω–∞ + 1 Snowflake (Staging + Analytics)**
–∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –ø—É–±–ª–∏–∫—É–µ—Ç –∏/–∏–ª–∏ —á–∏—Ç–∞–µ—Ç —Å—Ç—Ä–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ç–æ–ø–∏–∫–∏.
‚Üí –≠—Ç–æ –¥–∞—ë—Ç *–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–µ–±–∞–≥–∞.*

---

## ‚öôÔ∏è 1. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤

| –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å              | –†–æ–ª—å                                                 | Kafka Topics (in/out)                 | Snowflake –º–æ–¥–µ–ª–∏                |
| ------------------------ | ---------------------------------------------------- | ------------------------------------- | ------------------------------- |
| **Ingestor**             | –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Binance WS –∏ –ø—É–±–ª–∏–∫—É–µ—Ç –≤ Kafka    | `‚Üí ohlcv_raw`                         | `RAW.TRADES`                    |
| **Aggregator**           | –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Ç–∏–∫–∏ –≤ OHLCV (1m)                         | `‚Üê ohlcv_raw`, `‚Üí ohlcv_agg`          | `STAGING.OHLCV_AGG`             |
| **Strategy Engine**      | –ø—Ä–∏–º–µ–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É —Å–∏–≥–Ω–∞–ª–æ–≤ (WeakLow/WeakHigh, volume) | `‚Üê ohlcv_agg`, `‚Üí trading_signals`    | `ANALYTICS.TRADING_SIGNALS`     |
| **Order Executor**       | –∏—Å–ø–æ–ª–Ω—è–µ—Ç –æ—Ä–¥–µ—Ä–∞ –Ω–∞ Binance REST                     | `‚Üê trading_signals`, `‚Üí order_events` | `ANALYTICS.PORTFOLIO_PNL`       |
| **Notifier**             | –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Telegram / Discord —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è            | `‚Üê trading_signals`, `‚Üê order_events` | `MONITORING.METRICS`            |
| **DB Loader (Snowpipe)** | –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ —Ç–æ–ø–∏–∫–∏ –∏ –ø–∏—à–µ—Ç –≤ Snowflake      | `‚Üê *`                                 | –≤—Å–µ —Å—Ö–µ–º—ã RAW/STAGING/ANALYTICS |

---

## üß± 2. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä Kafka topics

| Topic             | Producer        | Consumer                 | –û–ø–∏—Å–∞–Ω–∏–µ                 |
| ----------------- | --------------- | ------------------------ | ------------------------ |
| `ohlcv_raw`       | Ingestor        | Aggregator               | –°—ã—Ä—ã–µ —Ç–∏–∫–∏ –æ—Ç Binance    |
| `ohlcv_agg`       | Aggregator      | Strategy Engine          | –ú–∏–Ω—É—Ç–Ω—ã–µ —Å–≤–µ—á–∏ (OHLCV)   |
| `trading_signals` | Strategy Engine | Order Executor, Notifier | –°–∏–≥–Ω–∞–ª—ã BUY/SELL/HOLD    |
| `order_events`    | Order Executor  | DB Loader, Notifier      | –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–¥–µ–ª–∫–∏ –∏ PnL |

**üü¢ 4 —Ç–æ–ø–∏–∫–∞ ‚Üí 6 –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤**
–∏–¥–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è MVP.

---

## üßÆ 3. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ Snowflake —Å—Ö–µ–º—ã –∏ –º–æ–¥–µ–ª–∏

| –°—Ö–µ–º–∞          | –¢–∞–±–ª–∏—Ü–∞            | –ò—Å—Ç–æ—á–Ω–∏–∫                | –¶–µ–ª—å                      |
| -------------- | ------------------ | ----------------------- | ------------------------- |
| **RAW**        | `TRADES`           | Kafka topic `ohlcv_raw` | –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ç–∏–∫–∏         |
| **STAGING**    | `OHLCV_AGG`        | dbt –∏–∑ RAW              | –°–≤–µ—á–∏                     |
| **ANALYTICS**  | `TRADING_SIGNALS`  | dbt –∏–∑ OHLCV            | –°–∏–≥–Ω–∞–ª—ã                   |
| **ANALYTICS**  | `PORTFOLIO_PNL`    | Kafka `order_events`    | –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫            |
| **MONITORING** | `METRICS` *(view)* | Prometheus exporter     | –û–±–∑–æ—Ä PnL, count, latency |

---

## üß© 4. Data Flow –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–º –≤–∏–¥–µ

```
[Binance WS]
     ‚Üì
 üß© Ingestor
     ‚Üì  (Kafka: ohlcv_raw)
 üß© Aggregator
     ‚Üì  (Kafka: ohlcv_agg)
 üß© Strategy Engine
     ‚Üì  (Kafka: trading_signals)
 üß© Order Executor
     ‚Üì  (Kafka: order_events)
 üß© DB Loader / Notifier
     ‚Üì
[Snowflake + Telegram + Grafana]
```

---

## üìò 5. –ü—Ä–∏–º–µ—Ä—ã —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–∞—Ç–∞–ª–æ–≥–æ–≤

```
marketflow/
 ‚îú‚îÄ ingestor/
 ‚îÇ   ‚îú‚îÄ main.py
 ‚îÇ   ‚îú‚îÄ kafka_client.py
 ‚îÇ   ‚îî‚îÄ Dockerfile
 ‚îú‚îÄ aggregator/
 ‚îÇ   ‚îú‚îÄ consumer.py
 ‚îÇ   ‚îú‚îÄ producer.py
 ‚îÇ   ‚îî‚îÄ Dockerfile
 ‚îú‚îÄ strategy/
 ‚îÇ   ‚îú‚îÄ engine.py
 ‚îÇ   ‚îú‚îÄ signals.py
 ‚îÇ   ‚îî‚îÄ Dockerfile
 ‚îú‚îÄ executor/
 ‚îÇ   ‚îú‚îÄ order_executor.py
 ‚îÇ   ‚îú‚îÄ telegram_notifier.py
 ‚îÇ   ‚îî‚îÄ Dockerfile
 ‚îú‚îÄ dbt/
 ‚îÇ   ‚îú‚îÄ models/
 ‚îÇ   ‚îÇ   ‚îú‚îÄ ohlcv_agg.sql
 ‚îÇ   ‚îÇ   ‚îú‚îÄ trading_signals.sql
 ‚îÇ   ‚îÇ   ‚îî‚îÄ portfolio_pnl.sql
 ‚îî‚îÄ infra/
     ‚îú‚îÄ kafka-topics.tf
     ‚îú‚îÄ snowflake-schema.tf
     ‚îî‚îÄ docker-compose.yaml
```

---

## üß∞ 6. –ü—Ä–∏–º–µ—Ä Kafka topics –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏ (Terraform)

**infra/kafka-topics.tf**

```hcl
resource "kafka_topic" "ohlcv_raw" {
  name = "ohlcv_raw"
  partitions = 3
  replication_factor = 1
}

resource "kafka_topic" "ohlcv_agg" {
  name = "ohlcv_agg"
  partitions = 3
}

resource "kafka_topic" "trading_signals" {
  name = "trading_signals"
  partitions = 3
}

resource "kafka_topic" "order_events" {
  name = "order_events"
  partitions = 3
}
```

---

## üß† 7. –ü—Ä–∏–º–µ—Ä Snowflake DDL

**infra/snowflake-schema.sql**

```sql
CREATE SCHEMA RAW;
CREATE SCHEMA STAGING;
CREATE SCHEMA ANALYTICS;

CREATE TABLE RAW.TRADES (
  symbol STRING,
  price FLOAT,
  qty FLOAT,
  ts TIMESTAMP_LTZ
);

CREATE TABLE STAGING.OHLCV_AGG (
  symbol STRING,
  t_min TIMESTAMP_LTZ,
  open FLOAT, high FLOAT, low FLOAT, close FLOAT,
  volume FLOAT
);

CREATE TABLE ANALYTICS.TRADING_SIGNALS (
  symbol STRING,
  t_min TIMESTAMP_LTZ,
  close FLOAT,
  volume FLOAT,
  momentum FLOAT,
  signal_type STRING
);

CREATE TABLE ANALYTICS.PORTFOLIO_PNL (
  symbol STRING,
  side STRING,
  price FLOAT,
  profit_pct FLOAT,
  ts TIMESTAMP_LTZ
);
```

---

## üß© 8. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ dbt –º–æ–¥–µ–ª–∏

**models/ohlcv_agg.sql**

```sql
select
  symbol,
  date_trunc('minute', ts) as t_min,
  min(price) as low,
  max(price) as high,
  avg(price) as close,
  first_value(price) over (partition by symbol order by ts) as open,
  sum(qty) as volume
from {{ source('raw','trades') }}
group by 1,2
```

**models/trading_signals.sql**

```sql
select
  *,
  case
    when close < lag(low, 1) over (partition by symbol order by t_min) * 1.008 then 'BUY'
    when close > lag(high, 1) over (partition by symbol order by t_min) * 0.992 then 'SELL'
    else 'HOLD'
  end as signal_type
from {{ ref('ohlcv_agg') }}
```

---

## üìä 9. –ü–æ—Ç–æ–∫ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞)

–ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ Prometheus:

| –ú–µ—Ç—Ä–∏–∫–∞                   | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç  |
| ------------------------- | ---------- |
| `messages_in_total`       | Ingestor   |
| `agg_latency_seconds`     | Aggregator |
| `signals_generated_total` | Strategy   |
| `orders_executed_total`   | Executor   |

Grafana Alloy —Å–æ–±–∏—Ä–∞–µ—Ç –∏—Ö –≤ –æ–±–ª–∞–∫–æ Grafana Cloud.

---

## üß≠ 10. –ß—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —É—Å–ø–µ—Ç—å –∑–∞ 2 –¥–Ω—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                 | –ó–∞–¥–∞—á–∞                           | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
| ------------------------- | -------------------------------- | --------- |
| Ingestor                  | ‚úÖ –≥–æ—Ç–æ–≤ ‚Äî —É–∂–µ –µ—Å—Ç—å               | 0.5–¥      |
| Aggregator                | –ø—Ä–æ—Å—Ç–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –º–∏–Ω—É—Ç–∞–º     | 0.5–¥      |
| Strategy                  | WeakLow/WeakHigh BUY/SELL –ª–æ–≥–∏–∫–∞ | 0.5–¥      |
| Order Executor + Telegram | REST –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è               | 0.5–¥      |
| Snowflake + dbt           | —Å—Ö–µ–º—ã + 2 –º–æ–¥–µ–ª–∏                 | 0.5–¥      |

**–ò—Ç–æ–≥–æ: ~2 –¥–Ω—è = –≥–æ—Ç–æ–≤—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—ã–π MarketFlow MVP.**

---

## üß© 11. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–ø–ª–æ—è

```bash
# 1. –°–æ–∑–¥–∞—Ç—å —Ç–æ–ø–∏–∫–∏
terraform apply -target=kafka_topic.*

# 2. –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—ã Snowflake
snow sql -f infra/snowflake-schema.sql

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
docker-compose up -d ingestor aggregator strategy executor
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

* –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –Ω–µ–∑–∞–≤–∏—Å–∏–º (–ª–µ–≥–∫–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –≤ AKS)
* Kafka-—Ç–æ–ø–∏–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã, –Ω–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã
* Snowflake —Å—Ö–µ–º—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ø–æ—Ç–æ–∫–∞–º
* dbt –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —á–∏—Å—Ç—É—é —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é
* Telegram / Grafana –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å
